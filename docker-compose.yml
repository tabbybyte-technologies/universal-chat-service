services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: universal-chat-api
    models:
      chat_model:
        endpoint_var: MODEL_BASE_URL
        model_var: MODEL_ID
    environment:
      PORT: ${PORT:-3000}
      API_KEY: ${API_KEY:-change-me}
      REDIS_URL: redis://redis:6379
      MEMORY_MAX_MESSAGES: ${MEMORY_MAX_MESSAGES:-20}
    ports:
      - "${PORT:-3030}:3000"
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: universal-redis
    command: ["redis-server", "--appendonly", "no"]
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

models:
  chat_model:
    model: ${DMR_MODEL:-ai/qwen3:4B-UD-Q4_K_XL}
    context_size: 4096
